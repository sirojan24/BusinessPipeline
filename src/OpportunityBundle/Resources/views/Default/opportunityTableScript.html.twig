<script>
    var $table = $('#table');
    var extendColData = [];
    var initResponse;
    $(document).ready(function () {
        $("#tableDiv").show();
        iniFillTableData();
    });

    function iniFillTableData() {
        $table.bootstrapTable('showLoading');
        var data = '{{opportunitiesArray}}';
        var newString = data.replace(/&quot;/g, '"');
        initResponse = newString;
        //var newString = JSON.parse(data);
        $table.bootstrapTable('hideLoading');
        $table.bootstrapTable('append', convertData(newString));
    }

    function refreshTable() {
        $table.bootstrapTable('removeAll');
        fillTableData();
    }

    function fillTableData() {
        $table.bootstrapTable('showLoading');
        $.post('{{path('opportunity_table_data')}}', null,
                function (response) {
                    if (response) {
                        $table.bootstrapTable('hideLoading');
                        initResponse = response;
                        $table.bootstrapTable('append', convertData(response));
                    } else {

                    }
                }
        );
    }

    function usernameFilter(username) {
        $table.bootstrapTable('removeAll');
        $table.bootstrapTable('showLoading');

        var jsonString = JSON.parse(initResponse);
        var filterOpportunities = [];
        
        for (var i = 0; i < jsonString.opportunities.length; i++) {
            var tempOpportunity = jsonString.opportunities[i];

            if (username === tempOpportunity.username.toLowerCase()) {
                filterOpportunities.push(tempOpportunity);
            }
            
        }
        var filterOpportunitiesArray = {'opportunities' : filterOpportunities};
        var jsonStr = JSON.stringify(filterOpportunitiesArray); 
        
        $table.bootstrapTable('hideLoading');
        $table.bootstrapTable('append', convertData(jsonStr));
    }

    function storePageSize(size) {
        $.post('{{path('login_login_saveconfig')}}',
                {name: 'contactview', value: size},
        function (response) {
            if (response !== "false") {

            } else {
                console.log("error occured in getting the manage view number in contacts", response);
            }
        });
    }

    function checkAndSetValue(value, blankValue, scale, pre) {
        if (value === '' || value === null) {
            return blankValue;
        } else {
            if (pre === true) {
                return scale + '' + value;
            } else {
                return value + '' + scale;
            }
        }
    }

    function detailFormatter(index, row) {

        var deal_account_type = checkAndSetValue(extendColData[index].deal_account_type, '-', '', true);
        var deal_source = checkAndSetValue(extendColData[index].deal_source, '-', '', true);
        var open_deals = checkAndSetValue(extendColData[index].open_deals, '-', '', true);
        var won_deals = checkAndSetValue(extendColData[index].won_deals, '-', '$', true);
        var lost_deals = checkAndSetValue(extendColData[index].lost_deals, '-', '$', true);

        var html = [];
        html.push('<div class"row">' +
                '<div class="col-xs-4">' +
                '<table class="table" style="margin-left:42px; border: none !important;line-height: 5px;">' +
                '<tr style="padding:0px;margin:0px;">' +
                '<td style="border: none !important;line-height: 5px;width:40%"><small>Deal Account Type</small></td>' +
                '<td style="border: none !important;line-height: 5px;"><small>' + deal_account_type + '</small></td>' +
                '</tr>' +
                '<tr style="padding:0px;margin:0px;">' +
                '<td style="border: none !important;line-height: 5px;"><small>Deal Source</small></td>' +
                '<td style="border: none !important;line-height: 5px;"><small>' + deal_source + '</small></td>' +
                '</tr>' +
                '<tr style="padding:0px;margin:0px;">' +
                '<td style="border: none !important;line-height: 5px;"><small>Open Deals</small></td>' +
                '<td style="border: none !important;line-height: 5px;"><small>' + open_deals + '</small></td>' +
                '</tr>' +
                '<tr style="padding:0px;margin:0px;">' +
                '<td style="border: none !important;line-height: 5px;"><small>Won Deals</small></td>' +
                '<td style="border: none !important;line-height: 5px;"><small>' + won_deals + '</small></td>' +
                '</tr>' +
                '<tr style="padding:0px;margin:0px;">' +
                '<td style="border: none !important;line-height: 5px;"><small>Lost Deals</small></td>' +
                '<td style="border: none !important;line-height: 5px;"><small>' + lost_deals + '</small></td>' +
                '</tr>' +
                '</table>' +
                '</div>' +
                '</div>');
        //html.push('<div class"row">' + index + '</div>');
        $.each(row, function (key, value) {
            //html.push('<p><b>' + key + ':</b> ' + value + '</p>');
        });
        return html.join('');
    }

    function convertData(response) {
        var jsonString = JSON.parse(response);

        var startId = 1,
                rows = [];

    {#for (var i = 0; i < jsonString.users.length; i++) {
        var tempUser = jsonString.users[i];#}
                for (var i = 0; i < jsonString.opportunities.length; i++) {
                    var tempOpportunity = jsonString.opportunities[i];

                    extendColData.push({
                        deal_account_type: tempOpportunity.deal_account_type,
                        deal_source: tempOpportunity.deal_source,
                        open_deals: tempOpportunity.open_deals,
                        won_deals: tempOpportunity.won_deals,
                        lost_deals: tempOpportunity.lost_deals
                    });

                    var editPath = '{{ path('contacts_contacts_editcontactpageV2',{'id':0} )}}';
                    editPath = editPath.substring(0, editPath.length - 1);

                    var name = '{{name|lower}}';
                    var action = '';

                    if (name === tempOpportunity.username.toLowerCase()) {
                        action = '<div class="pull-right">' +
                                '<div class="keep-open btn-group">' +
                                '<button class="btn btn-default btn-xs dropdown-toggle" data-toggle="dropdown">' +
                                '<i class="glyphicon glyphicon-chevron-down"></i>' +
                                '</button>' +
                                '<ul class="dropdown-menu" role="menu" style="min-width: 0px !important;">' +
                                '<li><a href="#"><i class="fa fa-usd"></i> New Deal</a></li>' +
                                '<li><a href="' + editPath + tempOpportunity.id + '"><i class="fa fa-pencil-square-o"></i> Edit</a></li>' +
                                '<li><a href="#"><i class="fa fa-file-o"></i> Notes</a></li>' +
                                '<li><a href="#"><i class="fa fa-list"></i> Tasks</a></li>' +
                                '</ul>' +
                                '</div>' +
                                '</div>';
                    }

                    if (tempOpportunity.weighted_revenue == '-1') {
                        tempOpportunity.weighted_revenue = tempOpportunity.weighted_revenue_all;
                    }

                    rows.push({
                        name: tempOpportunity.name,
                        company: tempOpportunity.company,
                        product_type: tempOpportunity.product_type,
                        stage: tempOpportunity.stage,
                        weighted_revenue: '$' + tempOpportunity.weighted_revenue,
                        projected_revenue: '$' + tempOpportunity.projected_revenue,
                        expected_closed_date: tempOpportunity.expected_closed_date,
                        owner: '<a href="javascript:usernameFilter(' + "'" + tempOpportunity.username + "'" + ')">' + tempOpportunity.owner + '</a>',
                        action: action
                    });
                }

                return rows;
            }

            function priceSorter(a, b) {
                a = +a.substring(1); // remove $
                b = +b.substring(1);
                if (a > b)
                    return 1;
                if (a < b)
                    return -1;
                return 0;
            }

            function rowStyle(row, index) {
                var classes = ['active'];

                if (index % 2 === 0) {
                    return {
                        classes: classes[0]
                    };
                }
                return {};
            }
</script>